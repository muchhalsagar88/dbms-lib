--Run the following query and use the output of the query as drop scripts

--SELECT 'DROP '||OBJECT_TYPE||' '||OBJECT_NAME||DECODE(OBJECT_TYPE,'TABLE', ' CASCADE CONSTRAINTS;', ';') FROM USER_OBJECTS;

--ALTER TABLE ENROLL
--  DROP CONSTRAINT FK_ENROLL_STUDENT_ID;


--ALTER TABLE ENROLL ADD (
--  CONSTRAINT FK_ENROLL_STUDENT_ID 
--  FOREIGN KEY (STUDENT_ID) 
--  REFERENCES PATRON (PATRON_ID)
--  ENABLE VALIDATE);


ALTER TABLE ENROLL
  DROP CONSTRAINT FK_ENROLL_STUDENT_ID;


ALTER TABLE ENROLL ADD (
  CONSTRAINT FK_ENROLL_STUDENT_ID 
  FOREIGN KEY (STUDENT_ID) 
  REFERENCES STUDENT (STUDENT_ID)
  ENABLE VALIDATE);


--ALTER TABLE TEACH
--  DROP CONSTRAINT FK_TEACH_FACULTY_ID;


--ALTER TABLE TEACH ADD (
--  CONSTRAINT FK_TEACH_FACULTY_ID 
--  FOREIGN KEY (FACULTY_ID) 
--  REFERENCES PATRON (PATRON_ID)
--  ENABLE VALIDATE);



ALTER TABLE TEACH
  DROP CONSTRAINT FK_TEACH_FACULTY_ID;


ALTER TABLE TEACH ADD (
  CONSTRAINT FK_TEACH_FACULTY_ID 
  FOREIGN KEY (FACULTY_ID) 
  REFERENCES FACULTY (FACULTY_ID)
  ENABLE VALIDATE);


ALTER TABLE ASSET ADD 
CONSTRAINT FK_ASSET_TYPE
 FOREIGN KEY (ASSET_TYPE)
 REFERENCES ASSET_TYPE (ASSETTYPEID)
 ENABLE
 VALIDATE;


CREATE TABLE PATRON_TYPE
(
  PATRON_TYPE_ID  CHAR(1 BYTE)              NOT NULL,
  DESCRIPTION     VARCHAR2(50 BYTE)             NOT NULL
);


ALTER TABLE PATRON_TYPE ADD (
  CONSTRAINT PATRON_TYPE_PK
  PRIMARY KEY
  (PATRON_TYPE_ID)
  ENABLE VALIDATE);


ALTER TABLE ASSET_PATRON_CONSTRAINT ADD 
CONSTRAINT ASSET_PATRON_CONSTRAINT_P_TYPE
 FOREIGN KEY (PATRON_TYPE)
 REFERENCES PATRON_TYPE (PATRON_TYPE_ID)
 ENABLE
 VALIDATE;


ALTER TABLE PATRON ADD 
CONSTRAINT FK_PATRON_TYPE
 FOREIGN KEY (PATRON_TYPE)
 REFERENCES PATRON_TYPE (PATRON_TYPE_ID)
 ENABLE
 VALIDATE;


ALTER TABLE ASSET_PATRON_CONSTRAINT ADD 
CONSTRAINT FK_ASSET_P_C_ASSET_TYPE
 FOREIGN KEY (ASSET_TYPE_ID)
 REFERENCES ASSET_TYPE (ASSETTYPEID)
 ENABLE
 VALIDATE;

CREATE OR REPLACE FUNCTION MY_HASH(X IN VARCHAR2, y IN NUMBER, z IN NUMBER) RETURN NUMBER IS
  RETVAL NUMBER;
BEGIN
  SELECT ORA_HASH(X,y,z) INTO RETVAL FROM DUAL;
  RETURN RETVAL;
END;
/

CREATE OR REPLACE TRIGGER LOGIN_PASSWORD
BEFORE INSERT OR UPDATE
OF PASSWORD
ON LOGIN_DETAILS
REFERENCING NEW AS New OLD AS Old
FOR EACH ROW
BEGIN
  :new.PASSWORD := MY_HASH(:new.PASSWORD, 100000, 57643);
END;
/



CREATE OR REPLACE TRIGGER UPD_ASSET_CK_CSTRN
AFTER INSERT OR UPDATE
OF RETURN_DATE
ON ASSET_CHECKOUT
REFERENCING NEW AS new OLD AS old
FOR EACH ROW
DECLARE
BEGIN
      IF UPDATING THEN
        IF :new.RETURN_DATE IS NOT NULL THEN
            DELETE FROM ASSET_CHECKOUT_CONSTRAINT ACC WHERE ACC.ASSETCHECKOUT_ID = :new.ID;
        END IF;
      ELSIF INSERTING THEN
        IF :new.RETURN_DATE IS NULL AND :new.ASSET_SECONDARY_ID IS NOT NULL THEN
            INSERT INTO ASSET_CHECKOUT_CONSTRAINT(ASSETCHECKOUT_ID, PATRON_ID, ASSET_SECONDARY_ID) VALUES (:new.ID, :new.PATRON_ID, :new.ASSET_SECONDARY_ID);
        END IF;
      END IF;
END;
/

show errors TRIGGER UPD_ASSET_CK_CSTRN;


CREATE OR REPLACE TRIGGER NO_CONF_ROOM_HILL
BEFORE INSERT OR UPDATE
ON ASSET
REFERENCING NEW AS new OLD AS old
FOR EACH ROW
DECLARE
cnt INTEGER;
BEGIN
        SELECT COUNT(*) INTO cnt FROM LIBRARY LIB, ASSET_TYPE AST WHERE AST.ASSETTYPEID = :new.ASSET_TYPE AND AST.SUB_CATEGORY = 'Conference Room' AND UPPER(LIB.LIBRARY_NAME) LIKE '%D%H%HILL%' AND LIB.LIBRARY_ID = :new.LIBRARY_ID;
        IF cnt > 0 THEN
            RAISE_APPLICATION_ERROR(-20013, 'NO_CNF_ROOM_IN_HILL');
        END IF;
END;
/

show errors TRIGGER NO_CONF_ROOM_HILL;


CREATE OR REPLACE TRIGGER NO_CONF_ROOM_STUDENT
BEFORE INSERT OR UPDATE
ON ROOM_RESERVATION
REFERENCING NEW AS new OLD AS old
FOR EACH ROW
DECLARE
cnt INTEGER;
BEGIN
        SELECT COUNT(*) INTO cnt FROM PATRON PT, ASSET_TYPE AST, ASSET ASS, PATRON_TYPE PTT WHERE ASS.ASSET_ID = :new.ROOM_ASSET_ID AND AST.ASSETTYPEID = ASS.ASSET_TYPE AND AST.SUB_CATEGORY = 'Conference Room' AND PT.PATRON_ID = :new.PATRON_ID AND PT.PATRON_TYPE = PTT.PATRON_TYPE_ID AND PTT.DESCRIPTION = 'Student' ;
        IF cnt > 0 THEN
            RAISE_APPLICATION_ERROR(-20013, 'NO_CONF_ROOM_STUDENT');
        END IF;
END;
/


show errors TRIGGER NO_CONF_ROOM_STUDENT;


CREATE OR REPLACE TRIGGER NO_RES_BOOK_FACULTY
BEFORE INSERT OR UPDATE
ON ASSET_CHECKOUT
REFERENCING NEW AS new OLD AS old
FOR EACH ROW
DECLARE
cnt INTEGER;
BEGIN
        SELECT COUNT(*) INTO cnt FROM PATRON PT, ASSET_TYPE AST, ASSET ASS, PATRON_TYPE PTT WHERE ASS.ASSET_ID = :new.ASSET_ASSET_ID AND AST.ASSETTYPEID = ASS.ASSET_TYPE AND AST.SUB_CATEGORY = 'Reserve Book' AND PT.PATRON_ID = :new.PATRON_ID AND PT.PATRON_TYPE = PTT.PATRON_TYPE_ID AND PTT.DESCRIPTION = 'Faculty' ;
        IF cnt > 0 THEN
            RAISE_APPLICATION_ERROR(-20013, 'NO_RESERVE_BOOK_FACULTY');
        END IF;
END;
/


show errors TRIGGER NO_RES_BOOK_FACULTY;


ALTER TABLE AUTHOR ADD 
 UNIQUE (NAME)
 ENABLE
 VALIDATE;
 
ALTER TABLE AUTHOR ADD 
 CHECK (NAME IS NOT NULL)
 ENABLE
 VALIDATE;

ALTER TABLE CLASSIFICATION ADD 
 UNIQUE (NAME)
 ENABLE
 VALIDATE;
 
ALTER TABLE CLASSIFICATION ADD 
 CHECK (NAME IS NOT NULL AND LOWER(NAME) IN ('undergraduate','postgraduate','graduate'))
 ENABLE
 VALIDATE;


ALTER TABLE COURSE ADD 
 UNIQUE (COURSE_NAME)
 ENABLE
 VALIDATE;
 
ALTER TABLE COURSE ADD 
 CHECK (COURSE_NAME IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE DEGREE_PROGRAM ADD 
 UNIQUE (NAME)
 ENABLE
 VALIDATE;
 
ALTER TABLE DEGREE_PROGRAM ADD 
 CHECK (NAME IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE FACULTY_CATEGORY ADD 
 UNIQUE (NAME)
 ENABLE
 VALIDATE;
 
ALTER TABLE FACULTY_CATEGORY ADD 
 CHECK (NAME IS NOT NULL)
 ENABLE
 VALIDATE;


ALTER TABLE LIBRARY ADD 
 UNIQUE (LIBRARY_NAME)
 ENABLE
 VALIDATE;
 
ALTER TABLE LIBRARY ADD 
 CHECK (LIBRARY_NAME IS NOT NULL)
 ENABLE
 VALIDATE;

ALTER TABLE LOGIN_DETAILS ADD 
 UNIQUE (PATRON_PATRON_ID)
 ENABLE
 VALIDATE;
 
ALTER TABLE LOGIN_DETAILS ADD 
 CHECK (PATRON_PATRON_ID IS NOT NULL)
 ENABLE
 VALIDATE;

ALTER TABLE LOGIN_DETAILS ADD 
 CHECK (PASSWORD IS NOT NULL)
 ENABLE
 VALIDATE;

ALTER TABLE PATRON ADD 
 CHECK (PATRON_TYPE IS NOT NULL)
 ENABLE
 VALIDATE;

ALTER TABLE PATRON ADD 
 CHECK (EMAIL_ADDRESS IS NOT NULL)
 ENABLE
 VALIDATE;

ALTER TABLE PATRON ADD 
 UNIQUE (EMAIL_ADDRESS)
 ENABLE
 VALIDATE;


ALTER TABLE PATRON ADD 
 CHECK (FIRST_NAME IS NOT NULL)
 ENABLE
 VALIDATE;


ALTER TABLE PATRON ADD 
 CHECK (NATIONALITY IS NOT NULL)
 ENABLE
 VALIDATE;


ALTER TABLE PATRON ADD 
 CHECK (DEPARTMENT_ID IS NOT NULL)
 ENABLE
 VALIDATE;


ALTER TABLE ROOM ADD 
 CHECK (FLOORLEVEL IS NOT NULL)
 ENABLE
 VALIDATE;
 
ALTER TABLE ROOM ADD 
 CHECK (FLOORLEVEL BETWEEN 0 AND 100)
 ENABLE
 VALIDATE;


ALTER TABLE ROOM ADD 
 CHECK (ROOMNO IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE ROOM ADD 
 UNIQUE(ROOMNO)
 ENABLE
 VALIDATE;

 
ALTER TABLE ROOM ADD 
 CHECK (CAPACITY IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE ROOM ADD 
 CHECK (CAPACITY BETWEEN 1 AND 25)
 ENABLE
 VALIDATE;


ALTER TABLE STUDENT ADD 
 CHECK (DOB IS NOT NULL)
 ENABLE
 VALIDATE;
 
--ALTER TABLE STUDENT ADD 
-- CHECK (TO_DATE(DOB) < SYSDATE)
-- ENABLE
-- VALIDATE; 

ALTER TABLE STUDENT ADD 
 CHECK (PHONE_NO IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE STUDENT ADD 
 CHECK (SEX IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE STUDENT ADD 
 CHECK (SEX IN ('Male','Female'))
 ENABLE
 VALIDATE;
 

ALTER TABLE STUDENT ADD 
 CHECK (ADDRESSLINEONE IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE STUDENT ADD 
 CHECK (CITYNAME IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE STUDENT ADD 
 CHECK (PINCODE IS NOT NULL)
 ENABLE
 VALIDATE;
 

ALTER TABLE STUDENT ADD 
 CHECK (PINCODE BETWEEN 1000 AND 999999)
 ENABLE
 VALIDATE;
 

ALTER TABLE STUDENT ADD 
 CHECK (DEGREEYEAR_DEGREE_YEAR_ID IS NOT NULL)
 ENABLE
 VALIDATE;


ALTER TABLE YEAR ADD 
 CHECK (NAME IS NOT NULL)
 ENABLE
 VALIDATE;


ALTER TABLE YEAR ADD 
 UNIQUE (NAME)
 ENABLE
 VALIDATE;


ALTER TABLE YEAR ADD 
 CHECK (LOWER(NAME) IN ('first year','second year','third year','fourth year','fifth year','sixth year'))
 ENABLE
 VALIDATE;

ALTER TABLE PUBLICATION ADD
  CHECK (PUBLICATIONFORMAT IN ('Physical copy','Electronic copy'))
 ENABLE
 VALIDATE;
 
CREATE OR REPLACE VIEW min_reservation_view (camera_id, issue_date, min_reserve_date) AS 
  SELECT c.camera_Id as id, c.issue_Date, MIN(c.reserve_Date) as res_date
				FROM Camera_Reservation c
				WHERE c.reservation_status='ACTIVE'
        GROUP BY c.camera_Id, c.issue_date;




CREATE OR REPLACE FUNCTION TS_DIFF_IN_HRS(END_TIME IN TIMESTAMP, START_TIME IN TIMESTAMP, DO_ROUND IN INTEGER) RETURN NUMBER IS
  RETVAL NUMBER;
BEGIN
  IF DO_ROUND < 0 THEN
  SELECT FLOOR(EXTRACT (DAY    FROM (END_TIME-START_TIME))*24) DELTA INTO RETVAL FROM DUAL;
  ELSIF DO_ROUND > 0 THEN
  SELECT FLOOR(EXTRACT (DAY    FROM (END_TIME-START_TIME))*24) DELTA INTO RETVAL FROM DUAL;
  ELSE
  SELECT EXTRACT (DAY    FROM (END_TIME-START_TIME))*24 DELTA INTO RETVAL FROM DUAL;
  END IF;
  RETURN RETVAL;
END;
/


CREATE OR REPLACE VIEW FINE_SNAPSHOT AS 
SELECT ISSUE_DATE, 
       DUE_DATE, 
       P.PATRON_ID, 
       P.PATRON_TYPE, 
       DURATION MAX_ALLOWED_DURATION, 
       SYSDATE TODAY, 
       TS_DIFF_IN_HRS(SYSDATE, DUE_DATE, 1) OVER_DUE_HRS, 
       CEIL(TS_DIFF_IN_HRS(SYSDATE, DUE_DATE, 1)/FINE_DURATION) OVER_DUE_TIME_Q, 
       APC.FINE*CEIL(TS_DIFF_IN_HRS(SYSDATE, DUE_DATE, 1)/FINE_DURATION) FINE_AMOUNT, 
       APC.FINE FINE_PER_TIME_Q, 
       FINE_DURATION TIME_Q_HRS, 
       AC.ID CHECKOUT_ID, 
       P.EMAIL_ADDRESS, 
       P.FIRST_NAME, 
       P.LAST_NAME
FROM 
    ASSET A, 
    ASSET_PATRON_CONSTRAINT APC, 
    ASSET_CHECKOUT AC,
    PATRON P
WHERE
    A.ASSET_TYPE = APC.ASSET_TYPE_ID
    AND A.ASSET_ID = AC.ASSET_ASSET_ID
    AND P.PATRON_ID = AC.PATRON_ID
    AND P.PATRON_TYPE = APC.PATRON_TYPE
    AND APC.FINE <> 0
    AND AC.RETURN_DATE IS NULL
    AND DUE_DATE < SYSDATE;


CREATE OR REPLACE VIEW DUE_IN_NEXT_24_HRS AS 
SELECT P.FIRST_NAME, 
       P.LAST_NAME,
       P.EMAIL_ADDRESS,
       ISSUE_DATE,
       DUE_DATE,
       SYSDATE TODAY, 
       P.PATRON_ID, 
       P.PATRON_TYPE, 
       AC.ID CHECKOUT_ID,
       A.ASSET_ID,
       (SELECT 'Camera: "' || MAKER || ' ' || MODEL || '"'  FROM
            CAMERA C, 
            CAMERA_DETAIL CD 
        WHERE (C.CAMERA_ID = A.ASSET_ID AND C.CAMERA_DETAIL_ID = CD.CAMERA_DETAIL_ID)
        UNION
        SELECT 'Journal: "' || TITLE || '"'  FROM
            JOURNAL J, 
            JOURNAL_DETAIL JD 
        WHERE (J.ISSN_NUMBER = JD.ISSN_NUMBER AND J.JOURNAL_ID = A.ASSET_ID)
        UNION
        SELECT 'Conference Proceeding: "' || TITLE || '"'  FROM
            CONF_PROCEEDING CP, 
            CONFERENCE_PROCEEDING_DETAIL CPD 
        WHERE (CP.CONF_NUM = CPD.CONF_NUM AND CP.CONF_PROC_ID = A.ASSET_ID)
        UNION
        SELECT 'Book: "' || TITLE || '"' FROM
            BOOK B, 
            BOOK_DETAIL BD 
        WHERE (B.ISBN_NUMBER = BD.ISBN_NUMBER AND B.BOOK_ID = A.ASSET_ID)) ASSET_NAME
FROM 
    ASSET A, 
    ASSET_CHECKOUT AC,
    PATRON P
WHERE
    A.ASSET_ID = AC.ASSET_ASSET_ID
    AND P.PATRON_ID = AC.PATRON_ID
    AND AC.RETURN_DATE IS NULL
    AND A.ASSET_TYPE NOT IN (SELECT ASSETTYPEID FROM ASSET_TYPE AT WHERE AT.CATEGORY = 'Room')
    AND DUE_DATE < SYSDATE+1
    AND DUE_DATE > SYSDATE;


CREATE OR REPLACE VIEW DUE_IN_NEXT_3_DAYS AS 
SELECT P.FIRST_NAME, 
       P.LAST_NAME,
       P.EMAIL_ADDRESS,
       ISSUE_DATE,
       DUE_DATE,
       SYSDATE TODAY, 
       P.PATRON_ID, 
       P.PATRON_TYPE, 
       AC.ID CHECKOUT_ID,
       A.ASSET_ID,
       (SELECT 'Camera: "' || MAKER || ' ' || MODEL || '"'  FROM
            CAMERA C, 
            CAMERA_DETAIL CD 
        WHERE (C.CAMERA_ID = A.ASSET_ID AND C.CAMERA_DETAIL_ID = CD.CAMERA_DETAIL_ID)
        UNION
        SELECT 'Journal: "' || TITLE || '"'  FROM
            JOURNAL J, 
            JOURNAL_DETAIL JD 
        WHERE (J.ISSN_NUMBER = JD.ISSN_NUMBER AND J.JOURNAL_ID = A.ASSET_ID)
        UNION
        SELECT 'Conference Proceeding: "' || TITLE || '"'  FROM
            CONF_PROCEEDING CP, 
            CONFERENCE_PROCEEDING_DETAIL CPD 
        WHERE (CP.CONF_NUM = CPD.CONF_NUM AND CP.CONF_PROC_ID = A.ASSET_ID)
        UNION
        SELECT 'Book: "' || TITLE || '"' FROM
            BOOK B, 
            BOOK_DETAIL BD 
        WHERE (B.ISBN_NUMBER = BD.ISBN_NUMBER AND B.BOOK_ID = A.ASSET_ID)) ASSET_NAME
FROM 
    ASSET A, 
    ASSET_CHECKOUT AC,
    PATRON P
WHERE
    A.ASSET_ID = AC.ASSET_ASSET_ID
    AND P.PATRON_ID = AC.PATRON_ID
    AND AC.RETURN_DATE IS NULL
    AND A.ASSET_TYPE NOT IN (SELECT ASSETTYPEID FROM ASSET_TYPE AT WHERE AT.CATEGORY = 'Room')
    AND DUE_DATE < SYSDATE+3
    AND DUE_DATE > SYSDATE+2;


    